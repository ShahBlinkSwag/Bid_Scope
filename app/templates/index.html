<!-- #app/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #f4f7f9; /* Light grey background */
        }
        .main-container {
    display: flex; /* Enables flexbox layout */
    align-items: start; /* Aligns children at the start of the container vertically */
    justify-content: space-between; /* Spreads children across the horizontal space */
    padding: 20px; /* Adds some padding around the containers */
}

.new-chat-container {
    display: flex;
    flex-direction: column;  /* Stack buttons vertically */
    align-items: flex-start; /* Align buttons to the left */
    gap: 10px;               /* Space between buttons */
}

.button-48 {
  appearance: none;
  background-color: #ffffff;
  border-width: 0;
  box-sizing: border-box;
  color: #000000;
  cursor: pointer;
  display: inline-block;
  /* font-family: Montserrat; */
  font-size: 20px;
  font-weight: 500;
  letter-spacing: 0;
  line-height: 1em;
  margin: 0;
  opacity: 1;
  outline: 0;
  padding: 1.5em 2.2em;
  position: relative;
  text-align: center;
  text-decoration: none;
  text-rendering: geometricprecision;
  text-transform: uppercase;
  transition: opacity 300ms cubic-bezier(.694, 0, 0.335, 1),background-color 100ms cubic-bezier(.694, 0, 0.335, 1),color 100ms cubic-bezier(.694, 0, 0.335, 1);
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  vertical-align: baseline;
  white-space: nowrap;
  width: 300px; 
    height: 70px;
    border-radius: 50px;
    margin-left: 20px;
}

.button-48:before {
  animation: opacityFallbackOut .5s step-end forwards;
  backface-visibility: hidden;
  background-color: #ebebeb9b;
  font-family: Clarkson,Helvetica,sans-serif;
  font-size: 20px;
  font-weight: 500;
  clip-path: polygon(-1% 0, 0 0, -25% 100%, -1% 100%);
  content: "";
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  transform: translateZ(0);
  transition: clip-path .5s cubic-bezier(.165, 0.84, 0.44, 1), -webkit-clip-path .5s cubic-bezier(.165, 0.84, 0.44, 1);
  width: 100%;
  border-radius: 50px;
  
}

.button-48:hover:before {
  animation: opacityFallbackIn 0s step-start forwards;
  clip-path: polygon(0 0, 101% 0, 101% 101%, 0 101%);
}

.button-48:after {
  background-color: #FFFFFF;
}

.button-48 span {
  z-index: 1;
  position: relative;
}
    .chat-container {
        flex: 3; /* Allows the container to take more space than the new chat container */
        height: 95vh; /* Existing styles */
        max-width: 1600px; /* Limit maximum width */
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 25px rgba(0,0,0,0.1);
        padding-right: 10px;
        margin-right: 20px;
    }

    #chatWindow {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        object-fit: cover;
    }
    .avatar {
        width: 40px;   
        height: 40px;
        border-radius: 50%; 
        margin-right: 10px; 
        vertical-align: middle; 
            }

    .message {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            font-size: 16px; /* Adjust this value as needed */
}
        .user-message {
            /* background-color: #007bff; */
            background-color: #a370f0;
            color: white;
            margin-left: auto;
            /* color: #ffffff; */
            align-self: flex-end;  
            font-size: 25px;
        }
        .bot-response {
            background-color: #e9ecef;
            color: #333;
            align-self: flex-start;  
            border-radius: 20px 20px 20px 0;
            font-size: 25px;
        }
        .input-group {
            display: flex;
            align-items: center; /* Ensures vertical alignment among items */
            /* gap: 100px; Adds space between elements */
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6; /* Fallback for browsers that don't support :focus-visible */
            border-radius: 8px;
            margin-right: 8px;
        }
        input[type="text"]:focus-visible {
            outline: none;
            border-color: #007bff;
        }
        .btn {
    width: 150px;           /* Ensure all buttons have the same width */
    padding: 10px 20px;     /* Padding for button text */
    font-size: 16px;        /* Font size similar to 'New Chat' button */
    text-align: center;     /* Center text within each button */
    background-color: #6c757d;
    color: white;
    border: none;
    cursor: pointer;        /* Cursor changes to pointer on hover */
}
.file-icon {
    height: 40px; /* Adjust this value to increase the size */
    width: auto; /* This will maintain the aspect ratio of the image */
    cursor: pointer; /* Indicates that the icon is clickable */
}

.file-icon:hover {
    transform: scale(1.15); /* Slightly enlarges the icon on hover for interactivity */
}

#fileUploadForm {
    display: flex;
    align-items: center; /* Aligns children (icon and button) vertically */
    justify-content: start; /* Aligns children at the start of the form */
    gap: 10px; /* Adds some space between the icon and the button */
}

/* Ensure the file input is invisible but functional */
input[type="file"] {
    opacity: 0;
    position: absolute;
    width: 0.1px;
    height: 0.1px;
    z-index: -1;
}

label[for="fileUpload"] {
    background: none;
    border: none;
    cursor: pointer;
}

.cssbuttons-io-button {
    width: 300px; 
    height: 80px;
  background: #a370f0;
  color: white;
  font-family: inherit;
  /* padding: 0.35em; */
  /* padding-left: 1.2em; */
  font-size: 18px;
  font-weight: 1000;
  border-radius: 0.9em;
  border: none;
  letter-spacing: 0.05em;
  display: flex;
  align-items: center;
  box-shadow: inset 0 0 1.6em -0.6em #714da6;
  overflow: hidden;
  position: relative;
  /* height: 2.8em; */
  /* padding-right: 3.3em; */
  cursor: pointer;
  margin-left: 20px;
  justify-content: center;
}

.cssbuttons-io-button .icon {
  background: white;
  /* margin-left: 1em; */
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px; 
    height: 60px;
  border-radius: 0.7em;
  box-shadow: 0.1em 0.1em 0.6em 0.2em #7b52b9;
  right: 0.3em;
  transition: all 0.3s;
}

.cssbuttons-io-button:hover .icon {
  width: calc(100% - 0.6em);
}

.cssbuttons-io-button .icon svg {
  width: 1.1em;
  transition: transform 0.3s;
  color: #7b52b9;
}

.cssbuttons-io-button:hover .icon svg {
  transform: translateX(0.1em);
}

.cssbuttons-io-button:active .icon {
  transform: scale(0.95);
}

label[for="fileUpload"] {
    background: none; /* Removes any background styling */
    border: none; /* Removes border */
}
        .btn:hover {
    background-color: #5a6268;  /* Darken button on hover for feedback */
}
.chat-btn {
    background-color: #5a6268; 
    color: white; 
    border: none; 
    width: 360px; 
    height: 50px; /* Fixed height for all buttons */
    border-radius: 15px; /* Rounded corners */
    font-size: 20px; /* Larger font size for better readability */
    margin-bottom: 0px; /* Space between buttons */
    cursor: pointer; /* Cursor changes to pointer on hover */
}

.chat-btn:hover {
    background-color: #018df9; /* Darker blue on hover for feedback */
}
        .btn:active {
            background-color: #ffffff;
        }
        .btn i {
            font-size: 1.2rem; /* Larger icons */
        }
        .fas.fa-spinner {
            color: #007bff; /* Primary color spinner */
            font-size: 24px; /* Larger spinner icon */
            animation: spin 1s linear infinite;
        }

        #loadingMessage {
            display: flex;
            justify-content: center;
            align-items: center;
            color: #007bff;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }

        #loadingMessage i {
            margin-right: 10px;
            font-size: 24px;
            animation: spin 2s linear infinite;
        }

        #loadingMessage img {
            display: block;
            margin: 10px auto;
            width: 50px;       
            height: auto;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
        .file-icon {
            cursor: pointer; /* Makes the icon appear clickable */
            height: 60px; /* Adjust size as needed */
            width: auto; /* Maintain aspect ratio */
            transition: transform 0.2s; /* Smooth transform on hover */
        }
        .send-button {
            height: 55px; /* Set the height of the button */
            align-items: center; /* Center the icon vertically inside the button */
            padding: 0 20px; /* Adjust padding for better visual appearance */
        }
        .file-icon:hover {
            transform: scale(1.1); /* Slightly enlarge the icon on hover */
        }

        input[type="file"] {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Optional: Style for the upload button if needed */
        #uploadFileBtn {
            margin-left: 10px; /* Space between the upload icon and button */
        }

.button-28 {
  appearance: none;
  background-color: transparent;
  border: 2px solid #1A1A1A;
  border-radius: 15px;
  box-sizing: border-box;
  color: #3B3B3B;
  cursor: pointer;
  display: inline-block;
  font-weight: 900;
  line-height: normal;
  margin: 0;
  min-height: 60px;
  min-width: 0;
  outline: none;
  padding: 8px 12px;
  text-align: center;
  text-decoration: none;
  transition: all 300ms cubic-bezier(.23, 1, 0.32, 1);
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  width: 100%;
  will-change: transform;
  font-size: 20px;
  font-weight: 500;
  margin-left: 20px;
}

.button-28:disabled {
  pointer-events: none;
}

.button-28:hover {
  color: #fff;
  background-color: #a370f0;
  box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
  transform: translateY(-2px);
}

.button-28:active {
  box-shadow: none;
  transform: translateY(0);
}

    </style>
    
<!-- <title>Chatbot</title>  -->
</head>
<body>
    <div class="main-container">
        <div class="new-chat-container">
            
            <button class="cssbuttons-io-button">
                
                New Chat
                
                <div class="icon">
                  <svg
                    height="24"
                    width="24"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                  
                    <path d="M0 0h24v24H0z" fill="none"></path>
                    <path
                      d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                      fill="currentColor"
                    ></path>
                  </svg>
                </div>
              </button>
              
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 1">Thread 1</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 2">Thread 2</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 3">Thread 3</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 4">Thread 4</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 5">Thread 5</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 6">Thread 6</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 7">Thread 7</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 8">Thread 8</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 9">Thread 9</button>
            <button type="button" class="button-28" style="font-weight: bold;" aria-label="Additional Button 10">Thread 10</button>

        </div>
        <div class="chat-container">
        <!-- <h2 class="text-center">Chatbot</h2> -->
        <div id="chatWindow" class="d-flex flex-column">
            <div id="loadingMessage" class="message bot-response" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <form id="chatForm" class="input-group">
            <!-- File Upload Button -->
            <label for="fileUpload" class="btn btn-light">
                <img src="static/attachment.png" alt="Attach file" class="file-icon">
                <input type="file" id="fileUpload" multiple style="display: none;">
            </label>
            <!-- Hidden Thread ID Input -->
            <input type="hidden" id="threadId" name="thread_id">
            <!-- Message Input Field -->
            <input type="text" id="messageInput" class="form-control" placeholder="Type your message here..." required>
            <!-- Send Message Button -->
            <button class="btn btn-primary send-button" type="submit" aria-label="Send"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
$(document).ready(function() {
    $('#chatForm').submit(function(event) {
        event.preventDefault();
        var messageText = $('#messageInput').val();
        if (messageText.trim() === '') {
            return;  // Avoid sending empty messages
        }

        var formData = new FormData(this);
        formData.append('message', messageText);
        $('#chatWindow').append('<div class="message user-message"><img src="static/User.png" class="avatar">' + messageText + '</div>');

        // Clear the message input field
        $('#messageInput').val('');

        // Append custom loading animation right after the user's message
        var loadingElementId = 'loadingMessage' + Date.now();  // Unique ID for each loading message
        var loadingHtml = '<div id="' + loadingElementId + '" class="message bot-response"><img src="static/wait.gif" style="width:50px;height:50px;"> </div>';
        $('#chatWindow').append(loadingHtml);

        scrollToBottom();
        

        $.ajax({
            type: 'POST',
            url: '/',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#' + loadingElementId).remove();  // Remove only the corresponding loading message
                // $('#chatWindow').append(response.message);
                $('#chatWindow').append('<div class="message bot-response"><img src="static/blinksigns_logo.jpg" class="avatar">' + response.message + '</div>');
                scrollToBottom();
            },
            error: function() {
                $('#' + loadingElementId).remove();  // Remove only the corresponding loading message
                $('#chatWindow').append('<div class="message bot-response"><img src="static/blinksigns_logo.jpg" class="avatar"> Failed to send message.</div>');
                scrollToBottom();
            }
        });
    });

    function scrollToBottom() {
        $('#chatWindow').animate({ scrollTop: $('#chatWindow')[0].scrollHeight }, 500);
    }
        });

        $('#fileUpload').on('change', function() {
            var files = $(this).prop('files');
            if (files.length === 0) {
                alert('Please select a file to upload.');
                return;
            }

            processFiles(0, files);  // Start processing from the first file
        });

        function processFiles(index, files) {
            if (index >= files.length) {
                return;  // No more files to process
            }

            var file = files[index];
            var fileName = file.name;
            var predefinedMessage = `From the file "${fileName}", Scan the bid files for critical information essential for bidding, topics like product specifications, submission guidelines, financial and legal compliance, delivery and packaging, and critical elements and deadlines and more and extracted details in an organized and structured manner, ensuring clarity and coherence. Extract information pertinent to bidding while avoiding repetition and maintaining a varied pattern of extraction. `;

            var formData = new FormData();
            formData.append('file', file);
            formData.append('message', predefinedMessage);
            formData.append('thread_id', $('#threadId').val());

            var loadingElementId = 'loadingMessage' + Date.now();
            var fileLoadingHtml = '<div id="' + loadingElementId + '" class="message bot-response"><img src="static/upload.gif" style="width:50px;height:50px;"> File Uploading...</div>';
            $('#chatWindow').append(fileLoadingHtml);

            scrollToBottom();

            $.ajax({
                type: 'POST',
                url: '/',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#' + loadingElementId).remove();
                    $('#chatWindow').append(response.message);
                    $('#messageInput').val('');
                    $('#threadId').val(response.thread_id);
                    scrollToBottom();
                    processFiles(index + 1, files);  // Process the next file
                },
                error: function(xhr, status, error) {
                    console.log("AJAX call failed. Status:", status, "Error:", error);
                    $('#' + loadingElementId).remove();
                    $('#chatWindow').append('<div class="message bot-response">Failed to upload file.</div>');
                    scrollToBottom();
                    processFiles(index + 1, files);  // Process the next file even if the current one fails
                }
    });
}

            $('.cssbuttons-io-button').click(function() {
                $('#threadId').val(''); // Reset the thread ID
                $('#chatWindow').html(''); // Clear the chat window
            });

            function scrollToBottom() {
                $('#chatWindow').animate({ scrollTop: $('#chatWindow')[0].scrollHeight }, 1000);
                    } 
    </script>
</body>
</html>