<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://codepen.io/chrisdothtml/pen/ojLzJK.css">

    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #141414;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }
        .new-chat-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 25px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .button-48 {
            appearance: none;
            background-color: #ffffff;
            border-width: 0;
            box-sizing: border-box;
            color: #000000;
            cursor: pointer;
            display: inline-block;
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 0;
            line-height: 1em;
            margin: 0;
            opacity: 1;
            outline: 0;
            padding: 1.5em 2.2em;
            position: relative;
            text-align: center;
            text-rendering: geometricprecision;
            text-transform: uppercase;
            transition: opacity 300ms cubic-bezier(.694, 0, 0.335, 1), background-color 100ms cubic-bezier(.694, 0, 0.335, 1), color 100ms cubic-bezier(.694, 0, 0.335, 1);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            vertical-align: baseline;
            white-space: nowrap;
            width: 300px;
            height: 70px;
            border-radius: 50px;
            margin-left: 20px;
        }
        .button-48:before {
            animation: opacityFallbackOut .5s step-end forwards;
            backface-visibility: hidden;
            background-color: #ebebeb9b;
            font-family: Clarkson, Helvetica, sans-serif;
            font-size: 20px;
            font-weight: 500;
            clip-path: polygon(-1% 0, 0 0, -25% 100%, -1% 100%);
            content: "";
            height: 100%;
            left: 0;
            position: absolute;
            top: 0;
            transform: translateZ(0);
            transition: clip-path .5s cubic-bezier(.165, 0.84, 0.44, 1), -webkit-clip-path .5s cubic-bezier(.165, 0.84, 0.44, 1);
            width: 100%;
            border-radius: 50px;
        }
        .button-48:hover:before {
            animation: opacityFallbackIn 0s step-start forwards;
            clip-path: polygon(0 0, 101% 0, 101% 101%, 0 101%);
        }
        .button-48:after {
            background-color: #FFFFFF;
        }
        .button-48 span {
            z-index: 1;
            position: relative;
        }
        .user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        .user-info h2 {
            margin: 0;
        }
        .user-info p {
            margin: 0;
        }
        #chatWindow {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .message {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
        }
        .user-message {
            background-color: #fcc404;
            color: black;
            margin-left: auto;
            align-self: flex-end;
        }
        .bot-response {
            background-color: #363636;
            color: #d8d6d6;
            align-self: flex-start;
        }

        .input-group {
            display: flex;
            align-items: center;
            padding: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 7px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-right: 10px;
        }
        input[type="text"]:focus-visible {
            outline: none;
            border-color: #050505;
        }
        .btn {
            width: 80px;
            padding: 5px 10px;
            font-size: 16px;
            text-align: center;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #5a6268;
        }
        .btn:active {
            background-color: #545b62;
        }
        .file-icon {
            height: 20px;
            width: auto;
            cursor: pointer;
        }
        .file-icon:hover {
            transform: scale(1.1);
        }
        #fileUploadForm {
            display: flex;
            align-items: center;
            justify-content: start;
            gap: 10px;
        }
        input[type="file"] {
            opacity: 0;
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            z-index: -1;
        }
        label[for="fileUpload"] {
            background: none;
            border: none;
            cursor: pointer;
        }
        .cssbuttons-io-button {
            width: 200px;
            height: 50px;
            background: #f9b904;
            color: 141414;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            border-radius: 0.9em;
            border: #fff;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin-top: 10px;
        }
        .cssbuttons-io-button .icon {
            background: #141414;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 0.7em;
            right: 0.3em;
            transition: all 0.3s;
        }
        .cssbuttons-io-button:hover .icon {
            width: calc(100% - 0.6em);
        }
        .cssbuttons-io-button .icon img {
            width: 35px;
            height: 35px;
        }
        .cssbuttons-io-button:hover .icon svg {
            transform: translateX(0.1em);
        }
        .cssbuttons-io-button:active .icon {
            transform: scale(0.95);
        }
        label[for="fileUpload"] {
            background: none;
            border: none;
        }
        .btn:hover {
            background-color: #5a6268;
        }
        .chat-btn {
            color: white;
            border: none;
            width: 360px;
            height: 50px;
            border-radius: 15px;
            font-size: 20px;
            margin-bottom: 0px;
            cursor: pointer;
        }
        .chat-btn:hover {
            background-color: #ffffff;
        }
        /* .btn:active {
            background-color: #ffffff;
        } */
        .btn i {
            font-size: 1.2rem;
        }
        .fas.fa-spinner {
            color: #000000;
            font-size: 24px;
            animation: spin 1s linear infinite;
        }
        #loadingMessage {
            display: flex;
            justify-content: center;
            align-items: center;
            color: #007bff;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }
        #loadingMessage i {
            margin-right: 10px;
            font-size: 24px;
            animation: spin 2s linear infinite;
        }
        #loadingMessage img {
            display: block;
            margin: 10px auto;
            width: 50px;
            height: auto;
        }
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
        /* .file-icon {
            cursor: pointer;
            height: 50px;
            width: auto;
            transition: transform 0.2s;
        } */
        .send-button {
            height: 43px;
            align-items: center;
            padding: 0 20px;
            color: #ffffff;
        }
        .file-icon:hover {
            transform: scale(1.1);
        }
        input[type="file"] {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        #uploadFileBtn {
            margin-left: 10px;
        }
        .button-28 {
            appearance: none;
            background-color: transparent;
            border: 2px solid #1A1A1A;
            border-radius: 15px;
            box-sizing: border-box;
            color: #3B3B3B;
            cursor: pointer;
            display: inline-block;
            font-weight: 900;
            line-height: normal;
            margin: 0;
            min-height: 40px;
            min-width: 0;
            outline: none;
            padding: 6px 9px;
            text-align: center;
            text-decoration: none;
            transition: all 300ms cubic-bezier(.23, 1, 0.32, 1);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            width: 100%;
            will-change: transform;
            font-size: 20px;
            font-weight: 500;
            margin-left: 20px;
        }
        .button-28:disabled {
            pointer-events: none;
        }
        .button-28:hover {
            color: #fff;
            background-color: #f9b904;
            box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
            transform: translateY(-2px);
        }
        .button-28:active {
            box-shadow: none;
            transform: translateY(0);
        }
        .button {
            display: block;
            background-color: #c0392b;
            width: 150px;
            height: 50px;
            line-height: 50px;
            margin-top: 550px;
            color: #fff;
            position: absolute;
            cursor: pointer;
            overflow: hidden;
            border-radius: 2.5px;
            box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.25s cubic-bezier(0.310, -0.105, 0.430, 1.400);
        }
        .button span,
        .button .icon {
            display: block;
            height: 100%;
            text-align: center;
            position: absolute;
            top: 0;
        }
        .button span {
            width: 72%;
            line-height: inherit;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            left: 0;
            transition: all 0.25s cubic-bezier(0.310, -0.105, 0.430, 1.400);
        }
        .button span::after {
            content: '';
            background-color: #a53125;
            width: 1px;
            height: 35%;
            position: absolute;
            top: 15%;
            right: -0.5px;
        }
        .button .icon {
            width: 28%;
            right: 0;
            transition: all 0.25s cubic-bezier(0.310, -0.105, 0.430, 1.400);
        }
        .button .icon .fa {
            font-size: 15px;
            vertical-align: middle;
            transition: all 0.25s ease, height 0.25s ease;
        }
        .button .icon .fa-remove {
            height: 18px;
        }
        .button .icon .fa-check {
            display: none;
        }
        .button.success,
        .button:hover {
            background-color: #610000;
        }
        .button.success .icon .fa-remove {
            display: none;
        }
        .button.success .icon .fa-check {
            display: inline-block;
        }
        .button:hover span {
            left: -72%;
            opacity: 0;
        }
        .button:hover .icon {
            width: 100%;
        }
        .button:hover .icon .fa {
            font-size: 22.5px;
        }
        .button:hover .icon .fa-remove {
            height: 23px;
        }
        .button:hover {
            opacity: .9;
        }
        .button:active {
            opacity: 1;
        }
        h3 {
            color: #fcc404
        }
        h6 {
            color: #ffffff
        }
        .btn-3 {
            background: #fcc504;
            border: 1px solid #141414;
            font-weight: 700;
            transition: all 150ms linear;
            width: 200px;
            height: 40px;
            color: #141414;
            margin-top: 10px;
        }
        .btn-3:hover {
            background: #141414;
            color: #fcc504;
        }

    </style>
</head>
<body>
    <div class="main-container">
        <div class="new-chat-container">
            <div>
                <h3>{{ username }}</h3>
                <h6>{{ role }}</h6>
            </div>
            <button class="cssbuttons-io-button" onclick="startNewChat()">
                <span class="button-text">New Chat</span>
                <div class="icon">
                    <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z" fill="currentColor"></path>
                    </svg>
                </div>
            </button>
            {% if role in ['Super Admin', 'Admin'] %}
                <button class="cssbuttons-io-button" onclick="window.location.href='/manage-users'">
                    <span class="button-text">Manage Users</span>
                    <div class="icon">
                        <img src="/static/manage_users.png" alt="Manage Users Icon">
                    </div>
                </button>
            {% endif %}
            <button class="cssbuttons-io-button" onclick="window.location.href='/edit-profile'">
                <span class="button-text">Edit Profile</span>
                <div class="icon">
                    <img src="/static/edit_profile.png" alt="Edit Profile Icon">
                </div>
            </button>
            <button class="button" role="button">
                <span>Logout</span>
                <div class="icon">
                    <i class="fa fa-remove"></i>
                    <i class="fa fa-check" style="display: none;"></i>
                </div>
            </button>
            {% for i, thread_id in enumerate(thread_ids[:5]) %}
                <button class="btn btn-3" onclick="loadThread('{{ thread_id }}')">Thread {{ i+1 }}</button>
            {% endfor %}
        </div>
        <div class="chat-container">
            <div id="chatWindow" class="d-flex flex-column">
                <div id="loadingMessage" class="message bot-response" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            <form id="chatForm" class="input-group">
                <label for="fileUpload" class="btn btn-light">
                    <img src="static/attachment.png" alt="Attach file" class="file-icon">
                    <input type="file" id="fileUpload" multiple style="display: none;">
                </label>
                <input type="hidden" id="threadId" name="thread_id">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message here..." required>
                <button class="btn btn-primary send-button" type="submit" aria-label="Send"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function logout() {
            localStorage.removeItem('logged_in');
            localStorage.removeItem('email');
            window.location.href = '/login';
        }

        function startNewChat() {
            location.reload(); // Reloads the page
        }

        document.addEventListener('DOMContentLoaded', function() {
            var logoutButton = document.querySelector('.button');
            logoutButton.addEventListener('click', function() {
                this.classList.add('success');
                setTimeout(function() {
                    logoutButton.classList.remove('success');
                    logout();
                }, 1000);
            });
        });

        $(document).ready(function() {
            if (!localStorage.getItem('logged_in')) {
                window.location.href = '/login';
            }
            $('#chatForm').submit(function(event) {
                event.preventDefault();
                var messageText = $('#messageInput').val();
                if (messageText.trim() === '') {
                    return;
                }
                var formData = new FormData(this);
                formData.append('message', messageText);
                $('#chatWindow').append('<div class="message user-message"><img src="static/User.png" class="avatar">' + messageText + '</div>');
                $('#messageInput').val('');
                var loadingElementId = 'loadingMessage' + Date.now();
                var loadingHtml = '<div id="' + loadingElementId + '" class="message bot-response"><img src="static/wait.gif" style="width:50px;height:50px;"> </div>';
                $('#chatWindow').append(loadingHtml);
                scrollToBottom();
                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $('#' + loadingElementId).remove();
                        $('#chatWindow').append('<div class="message bot-response"><img src="static/blinksigns_logo.jpg" class="avatar">' + response.message + '</div>');
                        scrollToBottom();
                    },
                    error: function() {
                        $('#' + loadingElementId).remove();
                        $('#chatWindow').append('<div class="message bot-response"><img src="static/blinksigns_logo.jpg" class="avatar"> Failed to send message.</div>');
                        scrollToBottom();
                    }
                });
            });
            function scrollToBottom() {
                $('#chatWindow').animate({ scrollTop: $('#chatWindow')[0].scrollHeight }, 500);
            }
        });

        $('#fileUpload').on('change', function() {
            var files = $(this).prop('files');
            if (files.length === 0) {
                alert('Please select a file to upload.');
                return;
            }
            processFiles(0, files);
        });

        function processFiles(index, files) {
            if (index >= files.length) {
                return;
            }
            var file = files[index];
            var fileName = file.name;
            var predefinedMessage = `From the file "${fileName}", Scan the bid files for critical information essential for bidding, topics like product specifications, submission guidelines, financial and legal compliance, delivery and packaging, and critical elements and deadlines and more and extracted details in an organized and structured manner, ensuring clarity and coherence. Extract information pertinent to bidding while avoiding repetition and maintaining a varied pattern of extraction. `;
            var formData = new FormData();
            formData.append('file', file);
            formData.append('message', predefinedMessage);
            formData.append('thread_id', $('#threadId').val());
            var loadingElementId = 'loadingMessage' + Date.now();
            var fileLoadingHtml = '<div id="' + loadingElementId + '" class="message bot-response"><img src="static/upload.gif" style="width:50px;height:50px;"> File Uploading...</div>';
            $('#chatWindow').append(fileLoadingHtml);
            scrollToBottom();
            $.ajax({
                type: 'POST',
                url: '/',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#' + loadingElementId).remove();
                    $('#chatWindow').append(response.message);
                    $('#messageInput').val('');
                    $('#threadId').val(response.thread_id);
                    scrollToBottom();
                    processFiles(index + 1, files);
                },
                error: function(xhr, status, error) {
                    $('#' + loadingElementId).remove();
                    $('#chatWindow').append('<div class="message bot-response">Failed to upload file.</div>');
                    scrollToBottom();
                    processFiles(index + 1, files);
                }
            });
        }

        function loadThread(threadId) {
            $.ajax({
                type: 'GET',
                url: '/get-thread-messages',
                data: { thread_id: threadId },
                success: function(response) {
                    if (response.messages) {
                        $('#chatWindow').html(''); // Clear the chat window
                        response.messages.forEach(function(msg) {
                            var messageClass = msg.role === 'user' ? 'user-message' : 'bot-response';
                            $('#chatWindow').append('<div class="message ' + messageClass + '"><img src="static/' + (msg.role === 'user' ? 'User.png' : 'blinksigns_logo.jpg') + '" class="avatar">' + msg.content + '</div>');
                        });
                        $('#threadId').val(threadId); // Set the current thread ID
                        scrollToBottom();
                    } else {
                        alert('Failed to load thread messages.');
                    }
                },
                error: function() {
                    alert('Failed to load thread messages.');
                }
            });
        }

        function scrollToBottom() {
            $('#chatWindow').animate({ scrollTop: $('#chatWindow')[0].scrollHeight }, 1000);
        }
    </script>
</body>
</html>
